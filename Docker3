ROM arm64v8/ubuntu:22.04

ENV PATH="/home/srini/Fastapi_app/conda/bin:${PATH}"
ARG PATH="/home/srini/Fastapi_app/conda/bin:${PATH}"

RUN apt-get update && \
    apt-get install -y wget && \
    apt-get -y install openssh-server && \
    apt-get install -y git && \
    rm -rf /var/lib/apt/lists/*

# Install Miniconda
#RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh && \
#    bash Miniconda3-latest-Linux-aarch64.sh -b -p /home/hcpdocker/data/fastapi/conda && \
#    rm -f Miniconda3-latest-Linux-aarch64.sh

# Create a virtual environment and install dependencies
RUN /home/hcpdocker/data/fastapi/conda/bin/conda create -y --name myenv python=3.10 && \
    /home/hcpdocker/data/fastapi/conda/bin/conda run -n myenv /bin/bash -c "conda install -y requests urllib3" && \
    /home/hcpdocker/data/fastapi/conda/bin/conda run -n myenv /bin/bash -c "/home/hcpdocker/data/fastapi/conda/bin/pip install --upgrade pip" && \
    /home/hcpdocker/data/fastapi/conda/bin/conda clean -afy
# Set the environment variable
ENV PATH="/home/hcpdocker/data/fastapi/conda/bin:${PATH}"

# Install Python 3.10 using conda
RUN /home/hcpdocker/data/fastapi/conda/bin/conda install -y python=3.10 && \
    /home/hcpdocker/data/fastapi/conda/bin/conda clean -afy

# Create a virtual environment and upgrade pip
RUN /home/hcpdocker/data/fastapi/conda/bin/python -m venv /home/hcpdocker/data/fastapi/myenv && \
    /home/hcpdocker/data/fastapi/myenv/bin/pip install --upgrade pip

# Create the directory for the SSH key
RUN mkdir -p /home/hcpdocker/data/fastapi/myenv/ssh-key

COPY ./kez /home/hcpdocker/data/fastapi/myenv/ssh-key/
COPY ./kez.pub /home/hcpdocker/data/fastapi/myenv/ssh-key/

# Configure SSH
RUN mkdir -p /root/.ssh && \
    cp /home/hcpdocker/data/fastapi/myenv/ssh-key/* /root/.ssh/ && \
    chmod 600 /root/.ssh/kez

RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

# Change to the directory for the SSH key
#COPY ./kez /home/srini/Fastapi_app/myenv/ssh-key
#COPY ./kez.pub /home/srini/Fastapi_app/myenv/ssh-key

#RUN mkdir -p /root/.ssh
#COPY ./.ssh /root/.ssh 
#RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

RUN conda install wheel

# Clone the repository and install dependencies
RUN git -c core.sshCommand="ssh -i /home/hcpdocker/data/fastapi/myenv/ssh-key/kez" clone --branch fast-api-export-endpoint git@github.com:HCP-Sense/hcp_py-core.git \
    && cd hcp_py-core \
    && python setup.py bdist_wheel --universal \
    && python -m pip install . \
    && pip install -r requirements.txt \
    && pip install tb-mqtt-client \
    && pip install pymmh3 \
    && pip install azure-storage-blob \
    && pip install azure-identity

EXPOSE 80

RUN touch /hcp_py-core/logfile.log
RUN chmod +rw /hcp_py-core/logfile.log

RUN rm -rf /home/srini/Fastapi_app/myenv/ssh-key
RUN rm -rf /root/.ssh


FROM arm64v8/ubuntu:22.04

ENV PATH="/home/hcpdocker/data/fastapi/conda/bin:${PATH}"

# Install system dependencies
RUN apt-get update && \
    apt-get install -y wget openssh-server git && \
    rm -rf /var/lib/apt/lists/*

# Install Miniconda
RUN wget http://repo.continuum.io/miniconda/Miniconda3-py39_4.9.2-Linux-aarch64.sh && \
    /bin/bash Miniconda3-py39_4.9.2-Linux-aarch64.sh -b -p /home/hcpdocker/data/fastapi/conda && \
    rm -f Miniconda3-py39_4.9.2-Linux-aarch64.sh

# Set the environment variables again after Miniconda installation
ENV PATH="/home/hcpdocker/data/fastapi/conda/bin:${PATH}"

# Create a virtual environment and install dependencies
RUN /home/hcpdocker/data/fastapi/conda/bin/conda create -y --name myenv python=3.10 && \
    /home/hcpdocker/data/fastapi/conda/bin/conda run -n myenv /bin/bash -c "conda install -y requests urllib3" && \
    /home/hcpdocker/data/fastapi/conda/bin/conda run -n myenv /bin/bash -c "/home/hcpdocker/data/fastapi/conda/bin/pip install --upgrade pip" && \
    /home/hcpdocker/data/fastapi/conda/bin/conda clean -afy


# Update pip inside the virtual environment
#RUN /home/hcpdocker/data/fastapi/myenv/conda install -y pip


#RUN mkdir -p /home/hcpdocker/data/fastapi/myenv/ssh-key
# Copy SSH keys
COPY ./kez /home/hcpdocker/data/fastapi/myenv/ssh-key/
COPY ./kez.pub /home/hcpdocker/data/fastapi/myenv/ssh-key/

# Configure SSH
RUN mkdir -p /root/.ssh && \
    cp /home/hcpdocker/data/fastapi/myenv/ssh-key/* /root/.ssh/ && \
    chmod 600 /root/.ssh/kez

RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

RUN conda install wheel

# Clone the repository
#RUN git -c core.sshCommand="ssh -i /home/hcpdocker/data/fastapi/myenv/ssh-key/kez" clone --branch fast-api-export-endpoint git@github.com:HCP-Sense/hcp_py-core.git 
# Set the working directory to the cloned repository
#WORKDIR /home/hcpdocker/data/fastapi/myenv/hcp_py-core
#RUN cd hcp_py-core 
#WORKDIR /home/hcpdocker/data/fastapi/myenv/hcp_py-core
#RUN python setup.py bdist_wheel --universal
#RUN python -m pip install .
# Install the wheel
#RUN conda run  pip install --upgrade pip
#RUN python -m pip install .
#RUN pip install -r requirements.txt
#    && pip install pymmh3 \
#    && pip install tb-mqtt-client \
#    && pip install azure-storage-blob \
#    && pip install azure-identity

# Install dependencies and clone the repository
#RUN /home/hcpdocker/data/fastapi/myenv/bin/conda install wheel && \
RUN git -c core.sshCommand="ssh -i /home/hcpdocker/data/fastapi/myenv/ssh-key/kez" clone --branch fast-api-export-endpoint git@github.com:HCP-Sense/hcp_py-core.git
RUN cd hcp_py-core
RUN python setup.py bdist_wheel --universal
#RUN python -m pip install . \
#    && python -m pip install -r requirements.txt \
#    && python -m pip install pymmh3 \
#    && python -m pip install azure-storage-blob \
#    && python -m pip install azure-identity

EXPOSE 80

#RUN touch /hcp_py-core/logfile.log

#RUN chmod +rw /hcp_py-core/logfie.log

RUN rm -rf COPY /home/hcpdocker/data/fastapi/myenv/ssh-key
RUN rm -rf /root/.ssh

RUN conda install wheel

# Clone the repository
RUN git -c core.sshCommand="ssh -i /home/hcpdocker/data/fastapi/myenv/ssh-key/kez" clone --branch fast-api-export-endpoint git@github.com:HCP-Sense/hcp_py-core.git /home/hcpdocker/data/fastapi/myenv/hcp_py-core
# Set the working directory to the cloned repository
WORKDIR /home/hcpdocker/data/fastapi/myenv/hcp_py-core
RUN python setup.py bdist_wheel --universal
RUN python -m pip install .
RUN pip install -r requirements.txt
# Uncomment and add any additional dependencies you need
#RUN pip install pymmh3 tb-mqtt-client azure-storage-blob azure-identity

 => ERROR [12/17] RUN python setup.py bdist_wheel --universal                                                                                                                                                                                                          3.6s 
------                                                                                                                                                                                                                                                                      
 > [12/17] RUN python setup.py bdist_wheel --universal:
3.256 Illegal instruction (core dumped)
------
Dockerfile:47
--------------------
  45 |     # Set the working directory to the cloned repository
  46 |     WORKDIR /home/hcpdocker/data/fastapi/myenv/hcp_py-core
  47 | >>> RUN python setup.py bdist_wheel --universal
  48 |     RUN python -m pip install .
  49 |     RUN pip install -r requirements.txt
--------------------
ERROR: failed to solve: process "/bin/sh -c python setup.py bdist_wheel --universal" did not complete successfully: exit code: 132

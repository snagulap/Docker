FROM arm64v8/ubuntu:22.04

ENV PATH="/home/srini/Fastapi_app/conda/bin:${PATH}"
ARG PATH="/home/srini/Fastapi_app/conda/bin:${PATH}"

RUN apt-get update && \
    apt-get install -y wget && \
    apt-get -y install openssh-server && \
    apt-get install -y git && \
    rm -rf /var/lib/apt/lists/*

# Install Miniconda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh && \
    bash Miniconda3-latest-Linux-aarch64.sh -b -p /home/srini/Fastapi_app/conda && \
    rm -f Miniconda3-latest-Linux-aarch64.sh

# Set the environment variable
ENV PATH="/home/srini/Fastapi_app/conda/bin:${PATH}"

# Install Python 3.10 using conda
RUN /home/srini/Fastapi_app/conda/bin/conda install -y python=3.10 && \
    /home/srini/Fastapi_app/conda/bin/conda clean -afy

# Create a virtual environment and upgrade pip
RUN /home/srini/Fastapi_app/conda/bin/python -m venv /home/srini/Fastapi_app/myenv && \
    /home/srini/Fastapi_app/myenv/bin/pip install --upgrade pip

# Create the directory for the SSH key
RUN mkdir -p /home/srini/Fastapi_app/myenv/ssh-key

# Change to the directory for the SSH key
COPY ./kez /home/srini/Fastapi_app/myenv/ssh-key
COPY ./kez.pub /home/srini/Fastapi_app/myenv/ssh-key

RUN mkdir -p /root/.ssh
COPY ./.ssh /root/.ssh 
RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

RUN conda install wheel

# Clone the repository and install dependencies
RUN git -c core.sshCommand="ssh -i /home/srini/Fastapi_app/myenv/ssh-key/kez" clone --branch fast-api-export-endpoint git@github.com:HCP-Sense/hcp_py-core.git \
    && cd hcp_py-core \
    && python setup.py bdist_wheel --universal \
    && python -m pip install . \
    && pip install -r requirements.txt \
    && pip install tb-mqtt-client \
    && pip install pymmh3 \
    && pip install azure-storage-blob \
    && pip install azure-identity

EXPOSE 80

RUN touch /hcp_py-core/logfile.log
RUN chmod +rw /hcp_py-core/logfile.log

RUN rm -rf /home/srini/Fastapi_app/myenv/ssh-key
RUN rm -rf /root/.ssh
